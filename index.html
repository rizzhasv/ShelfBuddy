<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShelfBuddy - Hugging Face</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen font-sans p-4 md:p-8">

<div class="max-w-2xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100">
    <div class="bg-orange-500 p-6 text-white flex justify-between items-center">
        <h2 class="text-2xl font-bold">üè† ShelfBuddy</h2>
        <span class="text-xs bg-orange-600 px-3 py-1 rounded-full">Hugging Face Mode</span>
    </div>

    <div class="p-6 space-y-8">
        <div id="userInfo" class="text-center text-xs text-slate-500">
            <button id="loginBtn" class="text-orange-600 font-bold underline">Login to use AI Chef</button>
            <span id="userEmail" class="hidden"></span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 bg-slate-50 p-4 rounded-2xl">
            <input id="itemName" type="text" placeholder="Item Name" class="md:col-span-2 p-4 border rounded-xl focus:ring-2 focus:ring-orange-500 outline-none">
            <select id="itemLoc" class="p-4 border rounded-xl bg-white">
                <option>Fridge</option>
                <option>Pantry</option>
                <option>Freezer</option>
            </select>
            <button id="addBtn" class="md:col-span-3 bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded-xl transition shadow-md active:scale-95 text-sm uppercase tracking-wider">
                Add to Inventory
            </button>
        </div>

        <div>
            <h3 class="text-lg font-bold text-slate-800 mb-4">üì¶ Current Stash</h3>
            <div id="inventoryList" class="space-y-3 max-h-80 overflow-y-auto pr-2">
                <p class="text-slate-400 italic text-sm">No items yet</p>
            </div>
        </div>

        <div class="bg-gradient-to-br from-orange-50 to-yellow-50 p-6 rounded-3xl border border-orange-100 shadow-inner">
            <div class="flex items-center gap-3 mb-4">
                <h3 class="text-orange-900 font-bold">AI Chef</h3>
            </div>
            <div id="aiOutput" class="text-sm text-orange-800 mb-5 italic leading-relaxed min-h-[40px]">Ready to cook?</div>
            <button id="aiBtn" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-4 rounded-2xl font-bold transition shadow-md active:scale-95 uppercase text-xs tracking-widest">
                Get Recipe Idea
            </button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCjhDnn_9INN-DlrvczYET3b2x-S4gbYUs",
        authDomain: "shelfbuddy-5b380.firebaseapp.com",
        projectId: "shelfbuddy-5b380",
        storageBucket: "shelfbuddy-5b380.appspot.com",
        messagingSenderId: "925894203959",
        appId: "1:925894203959:web:7e405ff12de8b549d2bdb2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    let currentItems = [];

    // --- Login Logic ---
    document.getElementById("loginBtn").onclick = () => signInWithPopup(auth, provider);
    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById("loginBtn").classList.add("hidden");
            document.getElementById("userEmail").innerText = `Logged in as ${user.email}`;
            document.getElementById("userEmail").classList.remove("hidden");
        }
    });

    // --- Inventory Logic ---
    const q = query(collection(db, "inventory"), orderBy("createdAt", "desc"));
    onSnapshot(q, (snapshot) => {
        const list = document.getElementById("inventoryList");
        list.innerHTML = "";
        currentItems = [];
        snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            currentItems.push(`${data.name} (${data.location})`);
            const div = document.createElement("div");
            div.className = "flex justify-between items-center p-4 bg-white border rounded-xl shadow-sm";
            div.innerHTML = `<div><span class="font-bold">${data.name}</span><span class="ml-2 text-xs bg-slate-100 px-2 py-1 rounded-full">${data.location}</span></div><button class="text-red-400 font-bold hover:text-red-600 transition">‚úï</button>`;
            div.querySelector("button").onclick = () => deleteDoc(doc(db, "inventory", docSnap.id));
            list.appendChild(div);
        });
        if (currentItems.length === 0) list.innerHTML = `<p class="text-slate-400 italic text-sm">No items yet</p>`;
    });

    document.getElementById("addBtn").onclick = async () => {
        const nameInput = document.getElementById("itemName");
        const name = nameInput.value.trim();
        if (!name) return;
        await addDoc(collection(db, "inventory"), { name, location: document.getElementById("itemLoc").value, createdAt: serverTimestamp() });
        nameInput.value = "";
    };

    // --- BACKEND AI CONNECTION ---
    document.getElementById("aiBtn").onclick = async () => {
        const user = auth.currentUser;
        if (!user) return alert("Please login first!");
        if (currentItems.length === 0) return alert("Add some food first!");

        const out = document.getElementById("aiOutput");
        out.innerText = "üë®‚Äçüç≥ Chef Hugging Face is thinking...";

        try {
            const idToken = await user.getIdToken();
            const response = await fetch("/api/chef", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${idToken}` 
                },
                body: JSON.stringify({ items: currentItems.join(", ") })
            });

            const data = await response.json();
            out.innerText = data.answer || "Error connecting to AI.";
        } catch (e) {
            out.innerText = "‚ùå Backend Error. Is your server running?";
        }
    };
</script>
</body>
</html>